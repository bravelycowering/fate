<!DOCTYPE html>
<html>
<head>
	<title>(It's a computer.)</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<style>
		body {
			background: black;
			color: white;
			font-size: 16px;
			font-family: Courier, monospace;
		}
		input {
			background: black;
			border: none;
			color: white;
			font-size: 16px;
			font-family: Courier, monospace;
			padding: 0px;
			min-width: 1px;
			max-width: 100%;
			box-sizing: border-box;
			caret-color: white;
			outline: none;
		}
		input::-ms-clear {
			display: none;
		}
		#log {
			white-space: pre-wrap;
			color: white;
			position: absolute;
			bottom: 0px;
			left: 0px;
			right: 0px;
			padding: 10px;
		}
		#label {
			position: fixed;
			top: 0px;
			left: 0px;
			width: 100%;
			height: 100%;
		}
	</style>
</head>
<body>
	<noscript>You need to enable javascript to play this game.</noscript>
	<label id="label">
		<div id="log"></div>
	</label>
	<script>
		// polyfills
		if (typeof Element.prototype.remove == "undefined") {
			Element.prototype.remove = function () {
				this.parentElement.removeChild(this);
			}
		}
		// elements setup
		var log = document.getElementById("log");
		var input = document.createElement("input");
		input.id = "input";
		input.size = 1;
		// event system
		var events = [];
		var schedule = [];
		var delay = 0;
		var paused = false;
		Function.prototype.schedule = function() {
			schedule.push({
				fun: this,
				args: arguments,
			});
		}
		function wait(s) {
			delay += s*1000;
		}
		function pause() {
			paused = true;
		}
		function unpause() {
			paused = false;
		}
		// file system
		var root = {
			type: "directory",
			modified: 0,
			created: 0,
			hidden: false,
			protected: false,
			password: "",
			content: {},
		};
		var wd = "/";
		function getRawPathParts(path) {
			var parts = path.trim().split("/");
			var i = 0;
			while (i < parts.length) {
				var val = parts[i];
				if (val == "" || val == ".") {
					parts.splice(i, 1);
				} else if (val == "..") {
					parts.splice(i-1, 2);
					i = i - 1;
				} else {
					i = i + 1;
				}
			}
			return parts;
		}
		function getPathParts(path) {
			if (path[0] == "/") {
				return getRawPathParts(path);
			} else {
				return getRawPathParts(wd+"/"+path);
			}
		}
		function normalizePath(path) {
			return "/"+getPathParts(path).join("/");
		}
		function queryDirectory(path, create) {
			var parts = getPathParts(path);
			var dir = root;
			var end = parts.length;
			if (create) {
				end = end - 1;
			}
			for (var i = 0; i < end; i++) {
				dir = dir.content[parts[i]];
				if (typeof dir != "object" || dir.type != "directory") {
					return null;
				}
			}
			if (create) {
				if (dir.content[parts[end]]) {
					return null;
				} else {
					return dir.content[parts[end]] = create;
				}
			}
			return dir;
		}
		// commands
		var commands = {};
		var commandhelp = {};
		// HELP COMMAND
		commandhelp.help = "Shows help information\nUsage: help [command]";
		commands.help = function (cmdlet) {
			if (cmdlet) {
				if (commandhelp[cmdlet.toLowerCase()]) {
					println(commandhelp[cmdlet.toLowerCase()]);
				} else {
					println("No help available for '" + cmdlet + "'");
				}
			} else {
				var commandlist = Object.keys(commands).sort();
				println("Available commands: " + commandlist.join(", ") + "\nType 'help [command]' for more information");
			}
		};
		// CLEAR COMMAND
		commandhelp.clear = "Clears the screen\nUsage: clear";
		commands.clear = function() {
			while (log.children.length > 0) {
				log.children[0].remove();
			}
		};
		// CD COMMAND
		commandhelp.cd = "Changes or displays the current directory\nUsage: cd [path...]";
		commands.cd = function(a) {
			if (a) {
				var newPath = normalizePath(this.arg);
				if (queryDirectory(newPath)) {
					wd = newPath;
				} else {
					println("Invalid path.")
				}
			} else {
				println(wd);
			}
		};
		// MKDIR COMMAND
		commandhelp.mkdir = "Creates a new directory\nUsage: mkdir <path...>";
		commands.mkdir = function(a) {
			if (a) {
				var newPath = normalizePath(this.arg);
				var dir = queryDirectory(newPath, {
					type: "directory",
					modified: Date.now(),
					created: Date.now(),
					hidden: false,
					protected: false,
					password: "",
					content: {},
				});
				if (dir) {
					println("Created directory "+newPath);
				} else {
					println("Invalid path.");
				}
			} else {
				println("No path specified.");
			}
		};
		// LS COMMAND
		commandhelp.ls = "Lists all files in a given directory\nUsage: ls [path...]";
		commands.ls = function(a) {
			var path = normalizePath(this.arg);
			var dir = queryDirectory(path);
			if (dir) {
				println("Contents of "+path);
				var keys = Object.keys(dir.content).sort();
				for (var i = 0; i < keys.length; i++) {
					println("  "+keys[i]+" ("+dir.content[keys[i]].type+")");
				}
				if (keys.length == 0) {
					println("  (empty)");
				}
			} else {
				println("Invalid path.");
			}
		};
		// event enter to submit command
		document.onkeypress = function (e) {
			if (e.which == 13) {
				var inp = input.value.trim();
				if (inp.length > 0) {
					input.remove();
					write(input.value + "\n");
					processCommand(inp);
					processEvents();
				}
			}
		};
		input.oninput = function (e) {
			input.size = input.value.length + 1;
			input.scrollLeft = 0;
		};
		function write(text, color) {
			var lines = text.split("\n");
			for (var i = 0; i < lines.length; i++) {
				if (lines[i].length > 0) {
					var span = document.createElement("span");
					span.style.color = color;
					log.appendChild(span).appendChild(document.createTextNode(lines[i]));
				}
				if (i + 1 < lines.length) {
					log.appendChild(document.createElement("br"));
				}
			}
		}
		function println(text, color) {
			write(text + "\n", color);
		}
		// writes default text
		println("Booting...............\nSDOS (c) 1988");
		processEvents();
		// log errors if they occur
		addEventListener("error", function (e) {
			error(e.error.stack);
		});
		function error(text) {
			write(text + "\n", "red");
		}
		// command processing
		function processCommand(text) {
			var args = text.split(" ");
			var cmd = args.shift();
			var arg = args.join(" ");
			var i = 0;
			while (i < args.length) {
				var val = args[i];
				if (val == "") {
					args.splice(i, 1);
				} else {
					i = i + 1;
				}
			}
			if (commands[cmd.toLowerCase()]) {
				commands[cmd.toLowerCase()].apply({
					args: args,
					arg: arg,
				}, args);
			} else {
				println("Bad command or filename. Try 'help'");
			}
		}
		// event processing
		function processEvents() {
			if (schedule.length > 0) {
				events = schedule.concat(events);
				schedule = [];
			}
			if (events.length == 0) {
				log.appendChild(document.createElement("br"));
				write(wd + "> ");
				log.appendChild(input);
				input.value = "";
				input.size = 1;
				input.focus();
				setTimeout(function() {
					input.focus();
				}, 100);
			} else {
				var event = events.shift();
				event.fun.apply(null, event.args);
				if (!paused) {
					setTimeout(processEvents, delay);
				}
				delay = 0;
			}
		}
	</script>
</body>
</html>